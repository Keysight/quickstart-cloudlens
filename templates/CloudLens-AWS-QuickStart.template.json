{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation template creates a CloudLens Quick Start environment with 2 Linux Instances. Copyright 2018  Keysight Technologies",
    "Parameters": {
        "VPCName": {
            "Type": "String",
            "Description": "VPC Name",
            "Default": "CloudLensQuickStartVPC"
        },
        "VPCCidrBlock": {
            "Type": "String",
            "Description": "VPC CIDR Block where the Quick Start setup would be deployed",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "192.168.0.0/16",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/16 to x.x.x.x/28."
        },
        "AvailabilityZones": {
            "Description": "List of Availability Zones to use for the subnets in the VPC. Note: The logical order is preserved and only 2 AZs are used for this deployment.",
            "Type": "List<AWS::EC2::AvailabilityZone::Name>"
        },
        "PublicPrimarySubnetCidrBlock": {
            "Type": "String",
            "Description": "Public Primary Subnet CIDR Block",
            "MinLength": "9",
            "MaxLength": "18",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/16 to x.x.x.x/28.",
            "Default": "192.168.1.0/24"
        },
        "PublicSecondarySubnetCidrBlock": {
            "Type": "String",
            "Description": "Public Secondary Subnet CIDR Block",
            "MinLength": "9",
            "MaxLength": "18",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/16 to x.x.x.x/28.",
            "Default": "192.168.2.0/24"
        },
        "EnablePublicIP": {
            "Type": "String",
            "Description": "Automatically enable public ip to instances created in this subnet",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "true"
        },
        "CloudLensProjectKey": {
            "Description": "CloudLens Project key for the source and tool instances",
            "Type": "String",
            "MinLength": "8",
            "Default": "<your project key>"
        },
        "CustomAMIId": {
            "Type": "String",
            "Description" : "Optional AMI ID for source instance, if not specified Ubuntu 16.04 is default"
        },
        "SourceInstanceType" : {
            "Description" : "EC2 instance type for source",
            "Type" : "String",
            "Default" : "m4.large",
            "AllowedValues" : [
                "c1.medium",
                "c1.xlarge",
                "c3.2xlarge",
                "c3.4xlarge",
                "c3.8xlarge",
                "c3.large",
                "c3.xlarge",
                "c4.2xlarge",
                "c4.4xlarge",
                "c4.8xlarge",
                "c4.large",
                "c4.xlarge",
                "c5.18xlarge",
                "c5.2xlarge",
                "c5.4xlarge",
                "c5.9xlarge",
                "c5.large",
                "c5.xlarge",
                "cc2.8xlarge",
                "cg1.4xlarge",
                "cr1.8xlarge",
                "d2.2xlarge",
                "d2.4xlarge",
                "d2.8xlarge",
                "d2.xlarge",
                "f1.16xlarge",
                "f1.2xlarge",
                "g2.2xlarge",
                "g2.8xlarge",
                "g3.16xlarge",
                "g3.4xlarge",
                "g3.8xlarge",
                "h1.16xlarge",
                "h1.2xlarge",
                "h1.4xlarge",
                "h1.8xlarge",
                "hs1.8xlarge",
                "i2.2xlarge",
                "i2.4xlarge",
                "i2.8xlarge",
                "i2.xlarge",
                "i3.16xlarge",
                "i3.2xlarge",
                "i3.4xlarge",
                "i3.8xlarge",
                "i3.large",
                "i3.xlarge",
                "m1.large",
                "m1.medium",
                "m1.small",
                "m1.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "m2.xlarge",
                "m3.2xlarge",
                "m3.large",
                "m3.medium",
                "m3.xlarge",
                "m4.10xlarge",
                "m4.16xlarge",
                "m4.2xlarge",
                "m4.4xlarge",
                "m4.large",
                "m4.xlarge",
                "m5.12xlarge",
                "m5.24xlarge",
                "m5.2xlarge",
                "m5.4xlarge",
                "m5.large",
                "m5.xlarge",
                "p2.16xlarge",
                "p2.8xlarge",
                "p2.xlarge",
                "p3.16xlarge",
                "p3.2xlarge",
                "p3.8xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge",
                "r3.large",
                "r3.xlarge",
                "r4.16xlarge",
                "r4.2xlarge",
                "r4.4xlarge",
                "r4.8xlarge",
                "r4.large",
                "r4.xlarge",
                "t1.micro",
                "t2.2xlarge",
                "t2.large",
                "t2.medium",
                "t2.micro",
                "t2.nano",
                "t2.small",
                "t2.xlarge",
                "x1.16xlarge",
                "x1.32xlarge",
                "x1e.16xlarge",
                "x1e.2xlarge",
                "x1e.32xlarge",
                "x1e.4xlarge",
                "x1e.8xlarge",
                "x1e.xlarge"
            ],
            "ConstraintDescription" : "Must be a valid EC2 instance type."
        },
        "ToolInstanceType" : {
            "Description" : "EC2 instance type for tool",
            "Type" : "String",
            "Default" : "m4.large",
            "AllowedValues" : [
                "c1.medium",
                "c1.xlarge",
                "c3.2xlarge",
                "c3.4xlarge",
                "c3.8xlarge",
                "c3.large",
                "c3.xlarge",
                "c4.2xlarge",
                "c4.4xlarge",
                "c4.8xlarge",
                "c4.large",
                "c4.xlarge",
                "cc2.8xlarge",
                "cg1.4xlarge",
                "cr1.8xlarge",
                "d2.2xlarge",
                "d2.4xlarge",
                "d2.8xlarge",
                "d2.xlarge",
                "f1.16xlarge",
                "f1.2xlarge",
                "g2.2xlarge",
                "g2.8xlarge",
                "g3.16xlarge",
                "g3.4xlarge",
                "g3.8xlarge",
                "h1.16xlarge",
                "h1.2xlarge",
                "h1.4xlarge",
                "h1.8xlarge",
                "hs1.8xlarge",
                "i2.2xlarge",
                "i2.4xlarge",
                "i2.8xlarge",
                "i2.xlarge",
                "i3.16xlarge",
                "i3.2xlarge",
                "i3.4xlarge",
                "i3.8xlarge",
                "i3.large",
                "i3.xlarge",
                "m1.large",
                "m1.medium",
                "m1.small",
                "m1.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "m2.xlarge",
                "m3.2xlarge",
                "m3.large",
                "m3.medium",
                "m3.xlarge",
                "m4.10xlarge",
                "m4.16xlarge",
                "m4.2xlarge",
                "m4.4xlarge",
                "m4.large",
                "m4.xlarge",
                "p2.16xlarge",
                "p2.8xlarge",
                "p2.xlarge",
                "p3.16xlarge",
                "p3.2xlarge",
                "p3.8xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge",
                "r3.large",
                "r3.xlarge",
                "r4.16xlarge",
                "r4.2xlarge",
                "r4.4xlarge",
                "r4.8xlarge",
                "r4.large",
                "r4.xlarge",
                "t1.micro",
                "t2.2xlarge",
                "t2.large",
                "t2.medium",
                "t2.micro",
                "t2.nano",
                "t2.small",
                "t2.xlarge",
                "x1.16xlarge",
                "x1.32xlarge",
                "x1e.16xlarge",
                "x1e.2xlarge",
                "x1e.32xlarge",
                "x1e.4xlarge",
                "x1e.8xlarge",
                "x1e.xlarge"
            ],
            "ConstraintDescription" : "Must be a valid EC2 instance type."
        },
        "SSHKeyName": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description" : "Key from current region for SSH access to EC2 instances"
        }
    },
    "Mappings": {
        "AWSAMIRegionMap": {
            "AMI": {
                "SRCUBUNTU": "ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20180522",
                "TOOLEAST": "eastwind-cloudlens-sensor-1.0-20180112"
            },
            "ap-northeast-1": {
                "SRCUBUNTU": "ami-48a45937",
                "TOOLEAST": "ami-9c68a7e3"
            },
            "ap-northeast-2": {
                "SRCUBUNTU": "ami-f030989e",
                "TOOLEAST": "ami-ef61cb81"
            },
            "ap-south-1": {
                "SRCUBUNTU": "ami-41e9c52e",
                "TOOLEAST": "ami-b74368d8"
            },
            "ap-southeast-1": {
                "SRCUBUNTU": "ami-81cefcfd",
                "TOOLEAST": "ami-458a8d39"
            },
            "ap-southeast-2": {
                "SRCUBUNTU": "ami-963cecf4",
                "TOOLEAST": "ami-c901deab"
            },
            "ca-central-1": {
                "SRCUBUNTU": "ami-7e21a11a",
                "TOOLEAST": "ami-e4088b80"
            },
            "eu-central-1": {
                "SRCUBUNTU": "ami-c7e0c82c",
                "TOOLEAST": "ami-d0c0f33b"
            },
            "eu-west-1": {
                "SRCUBUNTU": "ami-58d7e821",
                "TOOLEAST": "ami-36fef24f"
            },
            "eu-west-2": {
                "SRCUBUNTU": "ami-5daa463a",
                "TOOLEAST": "ami-8ded03ea"
            },
            "eu-west-3": {
                "SRCUBUNTU": "ami-1960d164",
                "TOOLEAST": "ami-7115a40c"
            },
            "sa-east-1": {
                "SRCUBUNTU": "ami-67fca30b",
                "TOOLEAST": "ami-7692c91a"
            },
            "us-east-1": {
                "SRCUBUNTU": "ami-a4dc46db",
                "TOOLEAST": "ami-e03d7e9f"
            },
            "us-east-2": {
                "SRCUBUNTU": "ami-6a003c0f",
                "TOOLEAST": "ami-27e7d942"
            },
            "us-west-1": {
                "SRCUBUNTU": "ami-8d948ced",
                "TOOLEAST": "ami-970beff4"
            },
            "us-west-2": {
                "SRCUBUNTU": "ami-db710fa3",
                "TOOLEAST": "ami-7a6e2c02"
            }
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/VPC.template.json",
                "Parameters": {
                    "VPCName": {
                        "Ref": "VPCName"
                    },
                    "VPCCidrBlock": {
                        "Ref": "VPCCidrBlock"
                    }
                },
                "Tags": [
                    {
                        "Key": "CreatedBy",
                        "Value": "CloudLens-QuickStart-Template"
                    },
                    {
                        "Key": "CloudLens Quick Start Project Key",
                        "Value": {
                            "Ref": "CloudLensProjectKey"
                        }
                    }
                ]
            }
        },
        "CloudLensPublicPrimarySubnet": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": "VPC",
            "Properties": {
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/Subnet.template.json",
                "Parameters": {
                    "CloudlensAvailabilityZone": {
                        "Fn::Select": [0, {"Ref": "AvailabilityZones"}]
                    },
                    "SubnetCidrBlock": {
                        "Ref": "PublicPrimarySubnetCidrBlock"
                    },
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VpcID"
                        ]
                    },
                    "MapPublicIpOnLaunch": {
                        "Ref": "EnablePublicIP"
                    },
                    "SubnetName" : "CloudLens Quickstart Primary Subnet"
                },
                "Tags": [
                    {
                        "Key": "CreatedBy",
                        "Value": "CloudLens-QuickStart-Template"
                    },
                    {
                        "Key": "CloudLens Quick Start Project Key",
                        "Value": {
                            "Ref": "CloudLensProjectKey"
                        }
                    }
                ]
            }
        },
        "CloudLensPublicSecondarySubnet": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": "VPC",
            "Properties": {
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/Subnet.template.json",
                "Parameters": {
                    "CloudlensAvailabilityZone": {
                        "Fn::Select": [1, {"Ref": "AvailabilityZones"}]
                    },
                    "SubnetCidrBlock": {
                        "Ref": "PublicSecondarySubnetCidrBlock"
                    },
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VpcID"
                        ]
                    },
                    "MapPublicIpOnLaunch": {
                        "Ref": "EnablePublicIP"
                    },
                    "SubnetName" : "CloudLens Quickstart Secondary Subnet"
                },
                "Tags": [
                    {
                        "Key": "CreatedBy",
                        "Value": "CloudLens-QuickStart-Template"
                    },
                    {
                        "Key": "CloudLens Quick Start Project Key",
                        "Value": {
                            "Ref": "CloudLensProjectKey"
                        }
                    }
                ]
            }
        },
        "IGW": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": [ "VPC", "CloudLensPublicPrimarySubnet", "CloudLensPublicSecondarySubnet" ],
            "Properties": {
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/InternetGateway.template.json",
                "Parameters": {
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VpcID"
                        ]
                    },
                    "PrimaryManagementSubnetId": {
                        "Fn::GetAtt": [
                            "CloudLensPublicPrimarySubnet",
                            "Outputs.SubnetId"
                        ]
                    },
                    "SecondaryManagementSubnetId": {
                        "Fn::GetAtt": [
                            "CloudLensPublicSecondarySubnet",
                            "Outputs.SubnetId"
                        ]
                    }
                },
                "Tags": [
                    {
                        "Key": "CreatedBy",
                        "Value": "CloudLens-QuickStart-Template"
                    },
                    {
                        "Key": "CloudLens Quick Start Project Key",
                        "Value": {
                            "Ref": "CloudLensProjectKey"
                        }
                    }
                ]
            }
        },
        "SourceInstance": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": [ "CloudLensQuickStartIAMInstanceProfile", "CloudLensQuickStartSecurityGroup" ],
            "Properties": {
                "Parameters": {
                    "ProjectKey": { "Ref": "CloudLensProjectKey" },
                    "InstanceType": { "Ref": "SourceInstanceType" },
                    "SSHKeyName": { "Ref": "SSHKeyName"},
                    "DefaultAMIId": {
                        "Fn::FindInMap": [
                            "AWSAMIRegionMap",
                            {
                                "Ref": "AWS::Region"
                            },
                            "SRCUBUNTU"
                        ]
                    },
                    "CustomAMIId": { "Ref": "CustomAMIId"},
                    "QuickStartIAMInstanceProfile": { "Fn::GetAtt": ["CloudLensQuickStartIAMInstanceProfile","Outputs.IAMInstanceProfile"] },
                    "CloudlensInstanceType": "CloudLens Quick Start Source Instance",
                    "PrimaryAutoscaleSubnet": {
                        "Fn::GetAtt": [
                            "CloudLensPublicPrimarySubnet",
                            "Outputs.SubnetId"
                        ]
                    },
                    "SecondaryAutoscaleSubnet":{
                        "Fn::GetAtt": [
                            "CloudLensPublicSecondarySubnet",
                            "Outputs.SubnetId"
                        ]
                    },
                    "SecurityGroupId": {
                        "Fn::GetAtt": [
                            "CloudLensQuickStartSecurityGroup",
                            "Outputs.InstanceSecurityGroup"
                        ]
                     }
                },
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/EC2-instance.template.json",
                "TimeoutInMinutes": "60"
            }
        },
        "ToolInstance": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": [ "CloudLensQuickStartIAMInstanceProfile", "CloudLensQuickStartSecurityGroup" ],
            "Properties": {
                "Parameters": {
                    "ProjectKey": { "Ref": "CloudLensProjectKey" },
                    "InstanceType": { "Ref": "ToolInstanceType" },
                    "SSHKeyName": { "Ref": "SSHKeyName"},
                    "DefaultAMIId": {
                        "Fn::FindInMap": [
                            "AWSAMIRegionMap",
                            {
                                "Ref": "AWS::Region"
                            },
                            "TOOLEAST"
                        ]
                    },
                    "CustomAMIId": "",
                    "QuickStartIAMInstanceProfile": { "Fn::GetAtt": [
                        "CloudLensQuickStartIAMInstanceProfile",
                        "Outputs.IAMInstanceProfile"
                    ] },
                    "CloudlensInstanceType": "CloudLens Quick Start Tool Instance",
                    "PrimaryAutoscaleSubnet": {
                        "Fn::GetAtt": [
                            "CloudLensPublicPrimarySubnet",
                            "Outputs.SubnetId"
                        ]
                    },
                    "SecondaryAutoscaleSubnet":{
                        "Fn::GetAtt": [
                            "CloudLensPublicSecondarySubnet",
                            "Outputs.SubnetId"
                        ]
                    },
                    "SecurityGroupId": {
                        "Fn::GetAtt": [
                            "CloudLensQuickStartSecurityGroup",
                            "Outputs.InstanceSecurityGroup"
                        ]
                     }
                },
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/EC2-instance.template.json",
                "TimeoutInMinutes": "60"
            }
        },
        "CloudLensQuickStartSecurityGroup": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": [ "VPC", "IAMRole" ],
            "Properties": {
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/SecurityGroup.template.json",
                "Parameters": {
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VpcID"
                        ]
                    }
                },
                "TimeoutInMinutes": "60"
            }
        },
        "CloudLensQuickStartIAMInstanceProfile": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": "IAMRole",
            "Properties": {
                "Parameters": {
                    "IAMRole": { "Fn::GetAtt": ["IAMRole","Outputs.IAMRole"] }
                },
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/IAMInstanceProfile.template.json",
                "TimeoutInMinutes": "60"
            }
        },
        "IAMRole": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://s3.amazonaws.com/cloudlens-automation/quickstart/IAMRole.template.json",
                "TimeoutInMinutes": "60"
            }
        }
    },
    "Outputs": {
        "VPC": {
            "Description": "Name of VPC",
            "Value" : {"Ref": "VPCName"}
        },
        "VPCCidrBlock": {
            "Description": "VPC CIDR block",
            "Value" : {"Ref": "VPCCidrBlock"}
        },
        "PublicPrimarySubnetCidrBlock": {
            "Description": "Public Subnet CIDR Block",
            "Value": {"Ref": "PublicPrimarySubnetCidrBlock"}
        },
        "PublicSecondarySubnetCidrBlock": {
            "Description": "Public Subnet CIDR Block",
            "Value": {"Ref": "PublicSecondarySubnetCidrBlock"}
        },
        "EnablePublicIP": {
            "Description": "Automatically enable public ip to instances created in this subnet",
            "Value": {"Ref": "EnablePublicIP"}
        },
        "SourceInstanceType": {
            "Description": "EC2 instance type used for Source",
            "Value" : {"Ref": "SourceInstanceType"}
        },
        "ToolInstanceType": {
            "Description": "EC2 instance type used for Tool",
            "Value" : {"Ref": "ToolInstanceType"}
        },
        "SshKey": {
            "Description": "SSH Key name used for Source and Tool instances",
            "Value" : {"Ref": "SSHKeyName"}
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface" : {
            "ParameterGroups" : [
                {
                    "Label": { "default": "VPC Configuration" },
                    "Parameters": [
                        "AvailabilityZones",
                        "VPCName",
                        "VPCCidrBlock",
                        "PublicPrimarySubnetCidrBlock",
                        "PublicSecondarySubnetCidrBlock",
                        "EnablePublicIP"
                    ]
                },
                {
                    "Label": { "default": "CloudLens Configuration" },
                    "Parameters": [ "CloudLensProjectKey" ]
                },
                {
                    "Label": { "default": "Source Instance Configuration" },
                    "Parameters": [ "CustomAMIId", "SourceInstanceType" ]
                },
                {
                    "Label": { "default": "Tool Instance Configuration" },
                    "Parameters": [ "ToolInstanceType" ]
                },
                {
                    "Label": { "default": "SSH Configuration" },
                    "Parameters": [ "SSHKeyName" ]
                }
            ],
            "ParameterLabels": {
                "AvailabilityZones": { "default": "Availability Zones" },
                "VPCName": { "default": "VPC Name" },
                "VPCCidrBlock": { "default": "VPC CIDR Block" },
                "PublicPrimarySubnetCidrBlock": { "default": "Public Primary Subnet" },
                "PublicSecondarySubnetCidrBlock": { "default": "Public Secondary Subnet" },
                "EnablePublicIP": { "default": "Enable Public IP" },
                "CloudLensProjectKey": { "default": "Project Key" },
                "CustomAMIId": { "default": "Optional Source AMI" },
                "SourceInstanceType": { "default": "Source Instance Type" },
                "ToolInstanceType": { "default": "Tool Instance Type" },
                "SSHKeyName": { "default": "SSH Configuration" }
            }
        }
    }
}
